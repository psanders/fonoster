#!/bin/bash

IP_NOTIFIER_HOST=<%= node[:ipNotifier][:host] %>
IP_NOTIFIER_PORT=<%= node[:ipNotifier][:port] %>
PROXY_IP_FILE=<%= node[:ipConsumer][:file] %>
ARI_HOST=<%= node[:ari][:host] %>
ARI_PORT=<%= node[:ari][:port] %>
ARI_USERNAME=<%= node[:ari][:username] %>
ARI_SECRET=<%= node[:ari][:secret] %>
OLD_PROXY_IP=$(cat ${PROXY_IP_FILE})
PROXY_IP=$(curl ${IP_NOTIFIER_HOST}:${IP_NOTIFIER_PORT})
SIP_CONF=/etc/asterisk/sip.conf

if [ "$OLD_PROXY_IP" != "$PROXY_IP" ]
then
    echo "Updating Asterisk Box w/ new proxyIp"
    sed -i "s/$OLD_PROXY_IP/$PROXY_IP/" $SIP_CONF
    curl -XPUT -u "$ARI_USERNAME:$ARI_SECRET" $ARI_HOST:$ARI_PORT/ari/asterisk/modules/chan_sip.so
fi

echo $PROXY_IP > $PROXY_IP_FILE